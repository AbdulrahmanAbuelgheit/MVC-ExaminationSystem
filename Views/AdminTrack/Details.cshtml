@model DisplayTrackDTO

@{
    ViewData["Title"] = "Track Details";
}

<div class="container my-5">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Track Details</h2>
        <hr class="w-25 mx-auto border-primary" />
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <h3 class="card-title text-secondary">@Model.TrackName</h3>
            <p class="card-text mb-2"><strong>Duration:</strong> @Model.Duration weeks</p>
            <p class="card-text mb-2"><strong>Capacity:</strong> @Model.Capacity</p>
            <p class="card-text"><strong>Supervisor:</strong> @Model.SupervisorName</p>
        </div>
    </div>

    <div class="mb-5">
        <h4 class="text-success mb-3">Branches Offering This Track</h4>
        <ul class="list-group">
            @foreach (var branch in Model.Branches)
            {
                <li class="list-group-item">@branch.BranchName</li>
            }
        </ul>
    </div>

    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-info">Courses in Track</h4>
            <a asp-action="AddCourse" asp-route-id="@Model.TrackID" class="btn btn-sm btn-outline-primary">+ Add Course</a>
        </div>
        <table class="table table-bordered table-hover shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var course in Model.Courses)
                {
                    <tr>
                        <td>@course.CrsName</td>
                        <td>@course.Description</td>
                        <td>
                            <a asp-action="DeleteCourse"
                            asp-controller="AdminTrack"
                            asp-route-courseId="@course.CrsID"
                            asp-route-trackId="@Model.TrackID"
                            onclick="return confirm('Are you sure you want to remove this course?')"
                            class="btn btn-sm btn-outline-danger">
                                Delete
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-info mb-0">Instructors in Track</h4>
            <a asp-action="AddInstructor"
               asp-route-id="@Model.TrackID"
               class="btn btn-sm btn-outline-primary">
                + Add Instructor
            </a>
        </div>

        <table class="table table-bordered table-hover shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th style="width: 220px;">Actions</th> <!-- optional: fix width -->
                </tr>
            </thead>
            <tbody>
                @foreach (var ins in Model.Instructors)
                {
                    <tr>
                        <td>@ins.InsName</td>
                        <td>@ins.Email</td>
                        <td>
                            @if (Model.SupervisorID != ins.InsID)
                            {
                                <div class="d-flex gap-2">
                                    <form method="post"
                                          asp-action="MakeInstructorSupervisor"
                                          asp-controller="AdminTrack"
                                          asp-route-insId="@ins.InsID"
                                          asp-route-trackId="@Model.TrackID"
                                          onsubmit="return confirm('Are you sure you want to make this instructor the track supervisor?')">
                                        <button type="submit" class="btn btn-sm btn-outline-success">
                                            Make Supervisor
                                        </button>
                                    </form>

                                    <a asp-action="RemoveInstructor"
                                       asp-controller="AdminTrack"
                                       asp-route-insId="@ins.InsID"
                                       asp-route-trackId="@Model.TrackID"
                                       onclick="return confirm('Are you sure you want to remove this instructor from track?')"
                                       class="btn btn-sm btn-outline-danger">
                                        Remove
                                    </a>
                                </div>
                            }
                            else
                            {
                                <span class="badge bg-success">Supervisor</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mb-5">
        <h4 class="text-warning mb-3">Enrolled Students</h4>

        <form method="get" asp-action="Details" asp-route-id="@Model.TrackID" class="mb-4 p-3 bg-light rounded shadow-sm">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="intakeYearFilter" class="form-label">Filter by Intake Year</label>
                    <select id="intakeYearFilter" name="intakeYear" class="form-select">
                        <option value="">All</option>
                        @foreach (var year in Model.Students.Select(s => s.IntakeYear).Distinct().OrderBy(y => y))
                        {
                            <option value="@year" selected="@(ViewContext.HttpContext.Request.Query["intakeYear"].ToString() == year.ToString() ? "selected" : "")">@year</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="sortOrder" class="form-label">Sort by</label>
                    <select id="sortOrder" name="sortOrder" class="form-select">
                        <option value="asc" selected="@(ViewContext.HttpContext.Request.Query["sortOrder"] == "asc" ? "selected" : "")">Ascending</option>
                        <option value="desc" selected="@(ViewContext.HttpContext.Request.Query["sortOrder"] == "desc" ? "selected" : "")">Descending</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>
            </div>
        </form>

        <table class="table table-striped table-hover shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Intake Year</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in Model.Students)
                {
                    <tr>
                        <td>@student.StdID</td>
                        <td>@student.Name</td>
                        <td>@student.Email</td>
                        <td>@student.IntakeYear</td>
                        <td>
                            <a asp-action="TransferStudent"
                               asp-route-studentId="@student.StdID"
                               asp-route-currentTrackId="@Model.TrackID"
                               class="btn btn-sm btn-outline-warning">
                                Transfer
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
